# mise.toml
min_version = "2024.11.1"

[tools]
node = "22"
bun = "latest"
# nak (nostr army knife) â€” CLI for Nostr relay interaction, event publishing, local relay
"go:github.com/fiatjaf/nak" = "latest"

[settings]
experimental = true

[hooks]
postinstall = "bun install"

[env]
# Default relay list (comma-separated WebSocket URLs)
PUBLIC_DEFAULT_RELAYS = "wss://relay.damus.io,wss://nos.lol,wss://relay.primal.net,wss://relay.snort.social,wss://nostr.wine,wss://relay.nostr.net,wss://nostr-pub.wellorder.net,wss://eden.nostr.land"
# Default Cashu mint URL
PUBLIC_DEFAULT_MINT = "https://mint.minibits.cash/Bitcoin"
# App metadata
PUBLIC_APP_NAME = "Bounty.ninja"
PUBLIC_APP_URL = "https://bounty.ninja"
# Anti-spam fee range (in sats)
PUBLIC_MIN_SUBMISSION_FEE = "10"
PUBLIC_MAX_SUBMISSION_FEE = "10000"
# Vote quorum threshold â€” percentage of total pledged sats required for consensus
PUBLIC_VOTE_QUORUM_PERCENT = "66"
# Maximum deadline duration in days (1 year)
PUBLIC_MAX_DEADLINE_DAYS = "365"
# NIP-50 search relay (must support search filter)
PUBLIC_SEARCH_RELAY = "wss://search.nos.today"
# Local relay URL for development (used by seed script)
LOCAL_RELAY = "ws://localhost:10547"
# SvelteKit-visible local relay (PUBLIC_ prefix required for client-side access)
PUBLIC_LOCAL_RELAY = "ws://localhost:10547"

[tasks.dev]
description = "Start the SvelteKit dev server with hot reloading"
run = "bun run dev"

[tasks.build]
description = "Build the static site for production"
run = "bun run build"

[tasks.preview]
description = "Preview the production build locally"
run = "bun run preview"

[tasks.test]
description = "Run unit and integration tests"
run = "bun run test:unit && bun run test:integration"

[tasks."test:unit"]
description = "Run unit tests only"
run = "bun run test:unit"

[tasks."test:integration"]
description = "Run integration tests only"
run = "bun run test:integration"

[tasks."test:e2e"]
description = "Run Playwright end-to-end tests"
run = "bun run test:e2e"

[tasks.relay]
description = "Start a local strfry relay via Docker at ws://localhost:10547"
run = "docker compose up relay"

[tasks."relay:start"]
description = "Start the local relay in the background (detached)"
run = "docker compose up -d relay"

[tasks."relay:stop"]
description = "Stop the local relay"
run = "docker compose down"

[tasks."relay:reset"]
description = "Stop relay and delete all stored events"
run = "docker compose down -v"

[tasks."relay:nak"]
description = "Start nak in-memory relay (lightweight, no Docker, but truncates kinds > 65535)"
run = "nak serve"

[tasks.seed]
description = "Seed the local relay with representative task data (all lifecycle states)"
run = "bun run scripts/seed-relay.ts"

[tasks."dev:full"]
description = "Start local relay, seed it, and run the dev server"
run = """
# Start the relay in the background
docker compose up -d relay
echo "Local strfry relay starting at ws://localhost:10547..."

# Wait for relay to be ready
sleep 3

# Seed with representative data
bun run scripts/seed-relay.ts

# Start the dev server (foreground â€” Ctrl+C to stop)
echo ""
echo "Starting dev server..."
bun run dev
"""

[tasks.lint]
description = "Run ESLint linting"
run = "bun run lint"

[tasks.format]
description = "Run Prettier formatting"
run = "bun run format"

[tasks.check]
description = "Run svelte-check for type errors"
run = "bun run check"

[tasks.deploy]
description = "Build and deploy to Cloudflare Pages (bounty.ninja)"
run = """
echo "ðŸ”¨ Building..."
bun run build

echo ""
echo "ðŸš€ Deploying to Cloudflare Pages..."
npx wrangler pages deploy build --project-name bounty-ninja --branch main --commit-dirty=true

echo ""
echo "âœ… Deployed to https://bounty.ninja"
"""

[tasks."deploy:preview"]
description = "Build and deploy a preview branch (not production)"
run = """
BRANCH="${1:-preview}"
echo "ðŸ”¨ Building..."
bun run build

echo ""
echo "ðŸš€ Deploying preview branch: $BRANCH"
npx wrangler pages deploy build --project-name bounty-ninja --branch "$BRANCH" --commit-dirty=true
"""

[tasks.clean]
description = "Remove build artifacts and caches"
run = "rm -rf build .svelte-kit node_modules/.vite"
